<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RGLG</title>
  <style>
    :root { --bg:#0b0b0b; --fg:#fff; --muted:#bbb; }
    * { box-sizing:border-box; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; }

    /* Header always clickable above everything */
    header {
      position:fixed; top:0; left:0; right:0; height:56px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 14px; background:rgba(0,0,0,.35);
      border-bottom:1px solid rgba(255,255,255,.15); backdrop-filter:blur(6px);
      z-index:1000; pointer-events:auto;
    }
    .brand { font-weight:700; letter-spacing:.2px; }
    .auth { display:flex; align-items:center; gap:8px; pointer-events:auto; }
    .chip { background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18);
      padding:6px 10px; border-radius:999px; font-size:.9rem; }

    /* Buttons / inputs */
    .btn { padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.06); color:#fff; cursor:pointer; }
    .btn.primary { background:#fff; color:#000; border-color:transparent; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    input, textarea { width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.06); color:#fff; }
    label { font-size:.9rem; opacity:.85; display:block; margin-bottom:6px; }
    .row { display:flex; gap:8px; align-items:center; }
    .field { margin:10px 0 14px; }

    /* Content stays under header */
    main { position:fixed; top:56px; left:0; right:0; bottom:0; overflow:auto; z-index:1; }

    /* Feed */
    #feed {
      position:relative;
      height:100%;
      overflow:auto;
      scroll-snap-type:y mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .card {
      position:relative;
      height:calc(100vh - 56px);
      width:100%;
      display:block;
      scroll-snap-align:start;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:#000;
    }
    .vid {
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover; object-position:center;
      background:#000;
    }
    .overlay {
      position:absolute; left:0; right:0; bottom:0;
      padding:16px 14px 18px;
      background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.4) 20%, rgba(0,0,0,.7) 70%);
      color:#fff; display:flex; gap:12px; align-items:flex-end;
    }
    .meta { flex:1; min-width:0; }
    .user { font-weight:700; margin-bottom:4px; opacity:.95; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .title { font-size:1.05rem; line-height:1.25; margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .caption { color:#ddd; opacity:.9; font-size:.95rem; line-height:1.25; display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .shadowed { text-shadow: 0 1px 2px rgba(0,0,0,.8), 0 2px 12px rgba(0,0,0,.6); }

    .side {
      display:grid; gap:10px; justify-items:center; margin:0 8px 8px 0;
    }
    .side button { width:44px; height:44px; border-radius:999px; border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.08); color:#fff; }

    /* Dialogs */
    dialog { border:none; border-radius:16px; padding:0; background:rgba(10,10,10,.92); color:#fff; width:min(560px,92vw); }
    dialog::backdrop { background:rgba(0,0,0,.6); z-index:1000; }
    .modal-head { display:flex; align-items:center; justify-content:space-between; padding:14px; border-bottom:1px solid rgba(255,255,255,.15); }
    .modal-body { padding:14px; }

    /* Account Center toggles */
    #courseCatalog { display:flex; flex-wrap:wrap; gap:8px; }
    #courseCatalog .btn[aria-pressed="true"] { background:#fff; color:#000; border-color:transparent; }
    #courseCatalog .btn[aria-pressed="false"] { background: rgba(0,0,0,.35); color:#fff; border-color: rgba(255,255,255,.2); }

    /* Toast */
    #toast { position:fixed; left:50%; bottom:80px; transform:translateX(-50%);
      background:rgba(0,0,0,.6); border:1px solid rgba(255,255,255,.25);
      padding:10px 14px; border-radius:12px; color:#fff; backdrop-filter:blur(6px);
      z-index:50; opacity:0; transition:opacity .25s; }
  </style>
</head>
<body>
  <header>
    <div class="brand">RGLG</div>
    <div class="auth" id="authBar">
      <span id="userChip" class="chip" hidden></span>
      <button id="loginBtn" class="btn">Log in</button>
      <button id="signupBtn" class="btn">Sign up</button>
      <button id="acctBtn" class="btn">Account</button>
      <button id="logoutBtn" class="btn" hidden>Log out</button>
    </div>
  </header>

  <main>
    <!-- FEED -->
    <div id="feed" aria-live="polite"></div>
  </main>

  <!-- Auth dialog -->
  <dialog id="authDialog">
    <div class="modal-head">
      <strong id="authTitle">Log in</strong>
      <button class="btn" id="authClose">✕</button>
    </div>
    <form id="authForm" class="modal-body">
      <div class="field">
        <label>Username</label>
        <input id="authUsername" required minlength="3" autocomplete="username">
      </div>
      <div class="field">
        <label>Password</label>
        <input id="authPassword" type="password" required minlength="6" autocomplete="current-password">
      </div>
      <div class="row">
        <button class="btn primary" type="submit">Continue</button>
        <button class="btn" type="button" id="switchMode">Create account</button>
      </div>
      <div id="authMsg" style="color:#ffb3b3; min-height:1.2em; margin-top:6px;"></div>
    </form>
  </dialog>

  <!-- Comments dialog (kept minimal here) -->
  <dialog id="commentsDialog">
    <div class="modal-head">
      <strong>Comments</strong>
      <button class="btn" id="commentsClose">✕</button>
    </div>
    <div class="modal-body">
      <div id="commentsList" style="display:grid; gap:8px; margin-bottom:12px;"></div>
      <form id="commentForm" class="row">
        <input id="commentInput" placeholder="Add a comment..." maxlength="300">
        <button class="btn primary">Post</button>
      </form>
      <div id="commentsMsg" style="color:#ffb3b3; min-height:1.2em; margin-top:6px;"></div>
    </div>
  </dialog>

  <!-- Account Center dialog (FULL) -->
  <dialog id="acctDialog">
    <div class="modal-head">
      <strong>Account Center</strong>
      <button id="closeAcct" class="btn">✕</button>
    </div>
    <div class="modal-body" style="max-height:min(68vh,600px);overflow:auto">
      <div class="field">
        <label>Username</label>
        <input id="acctUsername" disabled>
      </div>

      <div class="field">
        <label>Password</label>
        <div class="row">
          <input id="acctPasswordMasked" value="••••••••" disabled style="flex:1">
          <button id="acctChangePwBtn" class="btn">Change</button>
        </div>
        <form id="acctPwForm" class="field" style="display:none;margin-top:8px">
          <input id="pwOld" type="password" placeholder="Current password" required minlength="6">
          <input id="pwNew" type="password" placeholder="New password (≥ 6 chars)" required minlength="6">
          <div class="row">
            <button type="submit" class="btn primary">Save new password</button>
            <button id="pwCancel" type="button" class="btn">Cancel</button>
          </div>
          <span id="pwMsg" style="color:#ffb3b3;min-height:1.2em"></span>
        </form>
      </div>

      <div class="field">
        <label>Courses</label>
        <ul id="courseList" style="list-style:none;padding:0;margin:0;display:grid;gap:6px"></ul>
        <div style="margin-top:12px">
          <label style="display:block;margin-bottom:6px;opacity:.85">Available courses (toggle to add/remove)</label>
          <div id="courseCatalog"></div>
        </div>
        <span id="courseMsg" style="color:#ffb3b3;min-height:1.2em"></span>
      </div>
    </div>
  </dialog>

  <div id="toast"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Elements
      const userChip     = document.getElementById('userChip');
      const loginBtn     = document.getElementById('loginBtn');
      const signupBtn    = document.getElementById('signupBtn');
      const logoutBtn    = document.getElementById('logoutBtn');
      const acctBtn      = document.getElementById('acctBtn');

      const authDialog   = document.getElementById('authDialog');
      const authTitle    = document.getElementById('authTitle');
      const authClose    = document.getElementById('authClose');
      const authForm     = document.getElementById('authForm');
      const authUsername = document.getElementById('authUsername');
      const authPassword = document.getElementById('authPassword');
      const switchMode   = document.getElementById('switchMode');
      const authMsg      = document.getElementById('authMsg');
      let authMode = 'login';

      const acctDialog   = document.getElementById('acctDialog');
      const closeAcct    = document.getElementById('closeAcct');
      const acctUsername = document.getElementById('acctUsername');
      const acctChangePwBtn = document.getElementById('acctChangePwBtn');
      const acctPwForm   = document.getElementById('acctPwForm');
      const pwOld        = document.getElementById('pwOld');
      const pwNew        = document.getElementById('pwNew');
      const pwMsg        = document.getElementById('pwMsg');
      const pwCancel     = document.getElementById('pwCancel');
      const courseList   = document.getElementById('courseList');
      const courseCatalog= document.getElementById('courseCatalog');
      const courseMsg    = document.getElementById('courseMsg');
      const toastEl      = document.getElementById('toast');
      const feedEl       = document.getElementById('feed');

      function toast(msg){ toastEl.textContent = msg; toastEl.style.opacity='1'; setTimeout(()=> toastEl.style.opacity='0', 1400); }

      const api = {
        async get(p){ const r = await fetch(p, { credentials:'include' }); if(!r.ok) throw new Error(await r.text()); return r.json(); },
        async post(p,d){ const r = await fetch(p, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(d||{}), credentials:'include' }); const j = await r.json().catch(()=>({})); if(!r.ok) throw new Error(j.error||r.statusText); return j; }
      };

      // ==== FEED ====
      async function fetchFeed() {
        try {
          // Adjust endpoint to your server route if needed
          const data = await api.get('/api/feed');
          if (!Array.isArray(data) || !data.length) throw new Error('empty');
          return data;
        } catch (e) {
          // Fallback demo data (only if API fails)
          console.warn('Feed API unavailable, loading examples:', e.message || e);
          return [
            { id:'demo1', url:'/videos/demo1.mp4', title:'Demo video 1', caption:'This is a sample caption so you can see layout.', username:'demo_user' },
            { id:'demo2', url:'/videos/demo2.mp4', title:'Demo video 2', caption:'Replace with your real feed data.', username:'another_user' },
          ];
        }
      }

      function videoCard(item){
        const card = document.createElement('section'); card.className = 'card'; card.dataset.id = item.id || '';
        const vid = document.createElement('video');
        vid.className = 'vid';
        vid.src = item.url || item.videoUrl || item.src || '';
        vid.playsInline = true; vid.muted = true; vid.loop = true; vid.preload = 'metadata';
        vid.setAttribute('webkit-playsinline','');

        const overlay = document.createElement('div'); overlay.className = 'overlay';
        const meta = document.createElement('div'); meta.className = 'meta';
        const user = document.createElement('div'); user.className = 'user shadowed';
        user.textContent = item.username ? `@${item.username}` : '@unknown';
        const title = document.createElement('div'); title.className = 'title shadowed';
        title.textContent = item.title || 'Untitled';
        const caption = document.createElement('div'); caption.className = 'caption shadowed';
        caption.textContent = item.caption || '';

        meta.append(user, title, caption);

        const side = document.createElement('div'); side.className = 'side';
        side.style.marginLeft = '8px';
        const like = document.createElement('button'); like.className = 'btn'; like.textContent = '♥';
        const comment = document.createElement('button'); comment.className = 'btn'; comment.textContent = '💬';
        side.append(like, comment);

        overlay.append(meta, side);
        card.append(vid, overlay);
        return card;
      }

      function renderFeed(items){
        feedEl.innerHTML = '';
        items.forEach(item => feedEl.append(videoCard(item)));

        // Auto play/pause as you scroll
        const opts = { root: feedEl, threshold: 0.6 };
        const io = new IntersectionObserver(entries => {
          entries.forEach(e => {
            const v = e.target.querySelector('video');
            if (!v) return;
            if (e.isIntersecting) { v.play().catch(()=>{}); }
            else { v.pause(); }
          });
        }, opts);
        [...feedEl.children].forEach(card => io.observe(card));
      }

      // ==== AUTH ====
      function setMode(m){
        authMode = m;
        authTitle.textContent = m === 'login' ? 'Log in' : 'Create account';
        switchMode.textContent = m === 'login' ? 'Create account' : 'I already have an account';
        authMsg.textContent=''; authUsername.value=''; authPassword.value='';
      }
      loginBtn.addEventListener('click', () => { setMode('login'); authDialog.showModal(); authUsername.focus(); });
      signupBtn.addEventListener('click', () => { setMode('signup'); authDialog.showModal(); authUsername.focus(); });
      authClose.addEventListener('click', () => authDialog.close());
      switchMode.addEventListener('click', () => setMode(authMode === 'login' ? 'signup' : 'login'));

      authForm.addEventListener('submit', async (e)=>{
        e.preventDefault(); authMsg.textContent='';
        const username = authUsername.value.trim(); const password = authPassword.value;
        if (!username || password.length < 6){ authMsg.textContent='Enter a valid username & password.'; return; }
        try {
          if (authMode === 'login') await api.post('/api/auth/login', { username, password });
          else await api.post('/api/auth/signup', { username, password });
          authDialog.close(); onAuthChanged(); toast('Success');
        } catch (err) { authMsg.textContent = (err.message || 'Auth failed').replace(/["{}]/g,''); }
      });

      logoutBtn.addEventListener('click', async ()=>{ try{ await api.post('/api/auth/logout'); }catch{} onAuthChanged(); });

      async function onAuthChanged(){
        try {
          const me = await api.get('/api/me');
          if (me.username){
            userChip.hidden = false; userChip.textContent = `@${me.username}`;
            loginBtn.hidden = true; signupBtn.hidden = true; logoutBtn.hidden = false;
          } else {
            userChip.hidden = true; userChip.textContent = '';
            loginBtn.hidden = false; signupBtn.hidden = false; logoutBtn.hidden = true;
          }
        } catch {
          userChip.hidden = true; userChip.textContent = '';
          loginBtn.hidden = false; signupBtn.hidden = false; logoutBtn.hidden = true;
        }
      }

      // Account Center — CLICK HANDLER
      acctBtn.addEventListener('click', async () => {
        try {
          const me = await api.get('/api/me');
          if (!me.username) {
            setMode('signup');
            authDialog.showModal();
            authUsername.focus();
            toast('Please log in or sign up to access Account Center');
            return;
          }
          acctUsername.value = me.username;
          await loadCourses();
          acctDialog.showModal();
          acctUsername.focus();
        } catch (err) {
          console.error('Failed to fetch user data:', err);
          setMode('signup');
          authDialog.showModal();
          authUsername.focus();
          toast('Unable to load account data. Please try again.');
        }
      });

      // Debug: Verify button exists and is clickable
      console.log('[acct] acctBtn =', acctBtn);
      const r = acctBtn.getBoundingClientRect();
      const topEl = document.elementFromPoint(
        Math.floor((r.left + r.right) / 2),
        Math.floor((r.top + r.bottom) / 2)
      );
      console.log('[acct] element at button center =', topEl, 'is acctBtn?', topEl === acctBtn);

      closeAcct.addEventListener('click', () => acctDialog.close());

      // Password change flow
      acctChangePwBtn.addEventListener('click', ()=>{ acctPwForm.style.display='grid'; pwMsg.textContent=''; pwOld.value=''; pwNew.value=''; });
      pwCancel.addEventListener('click', ()=>{ acctPwForm.style.display='none'; pwMsg.textContent=''; });
      acctPwForm.addEventListener('submit', async (e)=>{
        e.preventDefault(); pwMsg.textContent='';
        try{
          const r = await fetch('/api/account/password', { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ oldPassword: pwOld.value, newPassword: pwNew.value }) });
          const out = await r.json().catch(()=>({}));
          if (!r.ok) { pwMsg.textContent = out.error || 'Failed to change password'; return; }
          acctPwForm.style.display='none'; toast('Password updated');
        } catch { pwMsg.textContent = 'Network error'; }
      });

      // Courses
      const AVAILABLE_COURSES = [
        "AP Calculus AB","AP Calculus BC","AP Biology","AP Chemistry","AP Physics 1","AP Physics 2",
        "AP Physics C: Mechanics","AP Physics C: Electricity and Magnetism","AP Environmental Science","AP Statistics",
        "AP Computer Science A","AP Computer Science Principles","AP English Language and Composition",
        "AP English Literature and Composition","AP U.S. History","AP World History","AP European History",
        "AP Human Geography","AP Macroeconomics","AP Microeconomics","AP Government and Politics: U.S.",
        "AP Government and Politics: Comparative","AP Psychology","AP Art History","AP Studio Art: 2-D Design",
        "AP Studio Art: 3-D Design","AP Studio Art: Drawing","AP Music Theory","AP French Language and Culture",
        "AP Spanish Language and Culture","AP Spanish Literature and Culture","AP German Language and Culture",
        "AP Italian Language and Culture","AP Chinese Language and Culture","AP Japanese Language and Culture",
        "AP Latin","AP Seminar","AP Research"
      ];
      async function loadCourses(){
        courseMsg.textContent = '';
        try {
          const res = await fetch('/api/account/courses', { credentials:'include' });
          if (!res.ok) throw new Error();
          const out = await res.json();
          renderCourses(out.courses || []);
        } catch {
          renderCourses([]); courseMsg.textContent = 'Courses unavailable (backend not implemented or 401).';
        }
      }

      function renderCourses(selected){
        // current selections
        courseList.innerHTML = '';
        (selected || []).forEach(name => {
          const li = document.createElement('li'); li.className = 'row';
          const span = document.createElement('span'); span.textContent = name; span.style.flex='1';
          const del = document.createElement('button'); del.className='btn'; del.textContent='Remove';
          del.addEventListener('click', async ()=>{
            try{
              const r = await fetch('/api/account/courses', { method:'DELETE', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name }) });
              if (!r.ok) throw new Error();
              await loadCourses();
            } catch { courseMsg.textContent = 'Failed to remove course.'; }
          });
          li.append(span, del); courseList.append(li);
        });
        renderCourseCatalog(selected || []);
      }

      function renderCourseCatalog(selected){
        courseCatalog.innerHTML = '';
        const set = new Set(selected);
        AVAILABLE_COURSES.forEach(name => {
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.textContent = name;
          const on = set.has(name);
          btn.setAttribute('aria-pressed', on ? 'true' : 'false');
          btn.addEventListener('click', async ()=>{
            const pressed = btn.getAttribute('aria-pressed') === 'true';
            try{
              if (!pressed) {
                const r = await fetch('/api/account/courses', { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name }) });
                if (!r.ok) throw new Error();
              } else {
                const r = await fetch('/api/account/courses', { method:'DELETE', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name }) });
                if (!r.ok) throw new Error();
              }
              await loadCourses();
            } catch { courseMsg.textContent = 'Update failed. Check network/backend.'; }
          });
          courseCatalog.append(btn);
        });
      }

      // Init
      (async () => {
        onAuthChanged();
        const items = await fetchFeed();
        renderFeed(items);
      })();
    });
  </script>
</body>
</html>